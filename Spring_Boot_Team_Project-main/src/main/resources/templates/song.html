<!DOCTYPE html>
<html xmlns:th="http://www.w3.org/1999/xhtml">
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://kit.fontawesome.com/412379eca8.js" crossorigin="anonymous"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@10/swiper-bundle.min.css">
<title>음악 플레이어</title>
<!-- common.css    -->
<link rel="stylesheet" type="text/css" href="/css/song_Page.css">

<!-- favicon.ico   -->
<link rel="icon" href="/images/favicon/favicon_2xl.png" />
<head>
    <meta charset="UTF-8">
    <title>Insert title here</title>
</head>
<body>


<div class="container">
    <h1>음악 플레이어</h1>
    <div class="music-container" id="musicContainer">
        <div class="music-info">
            <h4 id="title">노래 제목</h4>
            <div class="progress-container" id="progress-container">
                <div class="progress" id="progress">aa</div>
            </div>
        </div>
        <div class="img-container">
            <img src="" alt="cover" id="cover">
        </div>
        <div class="navigation">
            <button id="prev" class="action-btn"><i class="fa-sharp fa-solid fa-backward"></i></button>
            <button id="play" class="actiong-btn big"><i class="fa-solid fa-play"></i></button>
            <button id="next" class="actiong-btn"><i class="fa-sharp fa-solid fa-forward"></i></button>
        </div>


    </div>


</div>


<script>
    const playBtn = document.getElementById("play");
    const musicContainer = document.getElementById("musicContainer");
    const audio = document.getElementById("audio");
    const prevBtn = document.getElementById("prev");
    const nextBtn = document.getElementById("next");
    const progress = document.getElementById("progress");
    const progressContainer = document.getElementById('progress-container');
    const imgCover = document.getElementById("cover");
    const title = document.getElementById("title");
    let song;
    const songs = document.getElementById("title");

    let songIndex = 2;

    loadSong(songs[songIndex]);

    function loadSong(song) {
            title.innerHTML = song;
            console.log("song//"+song);
            var encodedTitle = encodeURIComponent(title.innerHTML);
            imgCover.src = '/image/'+encodedTitle+'.webp/';
            console.log("image//"+song);
    }

    function playMusic() {
      musicContainer.classList.add("play");

      playBtn.innerHTML = `<i class="fa-solid fa-pause"></i>`;

      audio.play();
    }

    function pauseMusic(){
        musicContainer.classList.remove('play');
        playBtn.innerHTML = `<i class="fa-solid fa-play"></i>`;

        audio.pause();
    }

    function playPrevSong() {
        songIndex--;

        if (songIndex < 0) {
          songIndex = songs.length - 1;
        }
        fetch('/previousplay',{
                method : 'GET',
            })
                .then(response => response.text())
                .then(data => {
                    loadSong(data);
                    console.log('PlayPreviousSong//'+ data);
                    playmusic(data);
                })
                .catch(error => {
                    console.error('Error playPreviousSong', error);
                });
    }

    function playNextSong (){
        songIndex++;

        if(songIndex > 2){
            songIndex = 0;
        }
        fetch('/nextplay',{
            method : 'GET',
        })
            .then(response => response.text())
            .then(data => {
                loadSong(data);
                console.log('PlayNextSong//'+ data);
                playmusic(data);
            })
            .catch(error => {
                console.error('Error playNextSong', error);
            });
    }

    function updateProgress(e){
        const {duration, currentTime} = e.srcElement;

        const progressPer = (currentTime / duration) * 100;

        progress.style.width = `${progressPer}%`;
    }

    function changeProgress(e){

        const width = e.target.clientWidth; // 전체 넓이

        const offsetX = e.offsetX; // 현재 x 좌표;

        const duration = audio.duration; // 재생길이

        audio.currentTime = (offsetX / width) * duration;

    }


    playBtn.addEventListener("click", () => {
        const isPlaying = musicContainer.classList.contains('play');
        const isLoop = true;

        if (isPlaying) {

            fetch('/pause', {
                method: 'GET',
            })
            .then(response => {
                if (response.ok) {
                    pauseMusic();
                } else {
                    console.error('서버 오류: ' + response.status);
                }
            })
            .catch(error => {
                console.error('오류 발생: ' + error);
            });
        } else {
            fetch('/play', {
                method: 'GET',
            })
            .then(response => {
                        if (response.ok) {
                            return response.text();
                        } else {
                            throw new Error('Failed to fetch data');
                        }
                    })
                    .then(responseSong => {
                        song = responseSong
                        console.log('responsesong'+song);
                        loadSong(song);
                        playMusic(song);
                    })
                    .catch(error => {
                        console.error('오류 발생: ' + error);
                    });
                }
            });

    prevBtn.addEventListener("click", playPrevSong);
    nextBtn.addEventListener('click', playNextSong);
    audio.addEventListener('ended', playNextSong);
    audio.addEventListener('timeupdate', updateProgress);

    progressContainer.addEventListener('click', changeProgress);
</script>


</body>
</html>